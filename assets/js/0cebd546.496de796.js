"use strict";(self.webpackChunkmoodle_docs=self.webpackChunkmoodle_docs||[]).push([[9290],{1721:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>l,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"github/submodules-update","title":"submodules-update","description":"The Workflow File","source":"@site/adm-docs/github/submodules-update.md","sourceDirName":"github","slug":"/github/submodules-update","permalink":"/moodle-docs/adm/github/submodules-update","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1764086659000,"frontMatter":{},"sidebar":"api","next":{"title":"Moodle Administrator","permalink":"/moodle-docs/adm/intro"}}');var i=t(4848),o=t(8453);const r={},l=void 0,h={},a=[{value:"The Workflow File",id:"the-workflow-file",level:2},{value:"Required Setup Steps",id:"required-setup-steps",level:2},{value:"Generate a Deploy Key",id:"generate-a-deploy-key",level:3},{value:"Add the Public Key to the Repo",id:"add-the-public-key-to-the-repo",level:3},{value:"Add the Private Key to Secrets",id:"add-the-private-key-to-secrets",level:3},{value:"Markdown code for the status badge.",id:"markdown-code-for-the-status-badge",level:3},{value:"Here is the step-by-step explanation of exactly what is happening in your workflow.",id:"here-is-the-step-by-step-explanation-of-exactly-what-is-happening-in-your-workflow",level:2},{value:"The Triggers (on)",id:"the-triggers-on",level:3},{value:"The Setup Phase (&quot;Configure SSH and Git&quot;)",id:"the-setup-phase-configure-ssh-and-git",level:3},{value:"The Execution Phase",id:"the-execution-phase",level:3},{value:"The Conditional Push (Safety Mechanism)",id:"the-conditional-push-safety-mechanism",level:3}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"the-workflow-file",children:"The Workflow File"}),"\n",(0,i.jsx)(n.p,{children:"Create new workflow file: (.github/workflows/update-submodules.yml)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:'name: Update Submodules\r\n\r\non:\r\n  workflow_dispatch: # Allows manual triggering\r\n  schedule:\r\n    - cron: "0 2 * * *" # Runs every day at 2:00 AM UTC (Optional)\r\n\r\njobs:\r\n  update-submodules:\r\n    runs-on: ubuntu-latest\r\n\r\n    steps:\r\n      - name: 1. Checkout Repository\r\n        # This action fetches the code into the workspace root (no extra folder needed).\r\n        uses: actions/checkout@v4\r\n\r\n      - name: 2. Configure SSH and Git (For PUSHING changes back)\r\n        run: |\r\n          # A. Identity Setup\r\n          git config --global user.email "github-actions[bot]@users.noreply.github.com"\r\n          git config --global user.name "github-actions[bot]"\r\n\r\n          # B. Key Creation (Same manual setup to enable git push)\r\n          mkdir -p ~/.ssh\r\n          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519\r\n          chmod 600 ~/.ssh/id_ed25519\r\n          ssh-keyscan github.com >> ~/.ssh/known_hosts\r\n\r\n      - name: 3. Execute Update and Push Script\r\n        # The commands now run from the root of the checked-out repository.\r\n        run: |\r\n          echo "Initialize submodules..."\r\n          # This must be run first on a fresh checkout\r\n          git submodule update --init\r\n\r\n          echo "Get version file.."\r\n          # Create or update the version file in the root\r\n          wget https://raw.githubusercontent.com/moodle/moodle/MOODLE_500_STABLE/version.php -O version.php\r\n\r\n          echo "Run: git submodule update --remote"\r\n          git submodule update --remote\r\n\r\n          # Check for changes\r\n          if [[ -n $(git status -s) ]]; then\r\n            echo "Changes detected. Committing..."\r\n            git add .\r\n            git commit -m "GitHub Actions submodule update."\r\n            # The SSH key allows this push\r\n            git push origin HEAD\r\n          else\r\n            echo "No changes detected. Skipping commit."\r\n          fi\n'})}),"\n",(0,i.jsx)(n.h2,{id:"required-setup-steps",children:"Required Setup Steps"}),"\n",(0,i.jsx)(n.p,{children:"To make this work, you cannot simply commit the file. You must configure the security credentials so GitHub Actions has permission to clone via SSH and push changes."}),"\n",(0,i.jsx)(n.h3,{id:"generate-a-deploy-key",children:"Generate a Deploy Key"}),"\n",(0,i.jsx)(n.p,{children:"Run this in your local terminal (do not add a passphrase):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'ssh-keygen -t ed25519 -C "github-actions" -f gh_deploy_key\n'})}),"\n",(0,i.jsx)(n.h3,{id:"add-the-public-key-to-the-repo",children:"Add the Public Key to the Repo"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cat gh_deploy_key.pub\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Copy the content of gh_deploy_key.pub."}),"\n",(0,i.jsx)(n.li,{children:"Go to the moodle500-plugins repository on GitHub."}),"\n",(0,i.jsx)(n.li,{children:"Navigate to Settings > Deploy keys."}),"\n",(0,i.jsx)(n.li,{children:"Click Add deploy key."}),"\n",(0,i.jsxs)(n.li,{children:["Title: ",(0,i.jsx)(n.code,{children:"GitHub Actions CI"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Important: Check the box Allow write access (otherwise the git push will fail)."}),"\n",(0,i.jsx)(n.li,{children:"Paste the key and save."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"add-the-private-key-to-secrets",children:"Add the Private Key to Secrets"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cat gh_deploy_key\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Copy the content of the private key file gh_deploy_key."}),"\n",(0,i.jsx)(n.li,{children:"Go to the repository where this Action will run."}),"\n",(0,i.jsx)(n.li,{children:"Navigate to Settings > Secrets and variables > Actions."}),"\n",(0,i.jsx)(n.li,{children:"Click New repository secret."}),"\n",(0,i.jsxs)(n.li,{children:["Name: ",(0,i.jsx)(n.code,{children:"SSH_PRIVATE_KEY"})]}),"\n",(0,i.jsx)(n.li,{children:"Paste the private key content and save."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"markdown-code-for-the-status-badge",children:"Markdown code for the status badge."}),"\n",(0,i.jsx)(n.p,{children:"Copy and paste this line at the very top of your README.md file:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-md",children:"[![Update Submodules](https://github.com/AdrianoRuseler/moodle500-plugins/actions/workflows/update-submodules.yml/badge.svg)](https://github.com/AdrianoRuseler/moodle500-plugins/actions/workflows/update-submodules.yml)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"here-is-the-step-by-step-explanation-of-exactly-what-is-happening-in-your-workflow",children:"Here is the step-by-step explanation of exactly what is happening in your workflow."}),"\n",(0,i.jsx)(n.h3,{id:"the-triggers-on",children:"The Triggers (on)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:'on:\r\n  workflow_dispatch: # 1. Manual Trigger\r\n  schedule:\r\n    - cron: "0 2 * * *" # 2. Automatic Schedule\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"workflow_dispatch"}),': Adds a "Run workflow" button in the GitHub Actions UI so you can test it anytime without waiting.']}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"schedule"}),": Uses cron syntax to run the job automatically every day at 2:00 AM UTC."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"the-setup-phase-configure-ssh-and-git",children:'The Setup Phase ("Configure SSH and Git")'}),"\n",(0,i.jsx)(n.p,{children:"This step prepares the fresh, empty Linux runner (server) to act like your local computer."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# A. Identity Setup\r\ngit config --global user.email "github-actions[bot]..."\r\ngit config --global user.name "github-actions[bot]"\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Why"}),': Git refuses to create a commit unless it knows who is committing. We use the standard GitHub bot identity here so the commits look "official."']}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# B. Key Creation\r\nmkdir -p ~/.ssh\r\necho "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519\r\nchmod 600 ~/.ssh/id_ed25519\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"The Magic"}),": We take the text stored in your GitHub Repository Secrets and write it to a physical file on the server (id_ed25519)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"chmod 600"}),": This is critical. SSH requires private keys to be read-only by the owner. If permissions are too open (like 777), SSH will refuse to use the key for security reasons."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# C. Trusting GitHub\r\nssh-keyscan github.com >> ~/.ssh/known_hosts\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Why"}),': When you SSH into a server for the first time, it usually asks: "The authenticity of host github.com can\'t be established. Are you sure?"']}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"the-execution-phase",children:"The Execution Phase"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# B. Update Logic\r\ngit submodule update --init\r\nwget ... -O version.php\r\ngit submodule update --remote\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"update --init"}),": If you added new submodules since the last run, this registers them locally."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"wget"}),": Overwrites version.php with the latest raw file from Moodle HQ."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"update --remote"}),": This is the heavy lifter. It goes into every submodule folder and pulls the latest commit from that submodule's remote branch (usually master or main)."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"the-conditional-push-safety-mechanism",children:"The Conditional Push (Safety Mechanism)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'if [[ -n $(git status -s) ]]; then\r\n  echo "Changes detected. Committing..."\r\n  git add .\r\n  git commit -m "GitHub Actions submodule update."\r\n  git push origin HEAD\r\nelse\r\n  echo "No changes detected..."\r\nfi\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"git status -s"}),": This prints a short summary of changes."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"The Logic:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"If the output is not empty (-n), it means submodules were updated or version.php changed. We commit and push."}),"\n",(0,i.jsx)(n.li,{children:"If the output is empty, we do nothing."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Why"}),': If we ran git commit when there were no changes, the Action would crash with an error ("nothing to commit"). This if block ensures the job always ends green (success).']}),"\n"]}),"\n"]})]})}function c(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>l});var s=t(6540);const i={},o=s.createContext(i);function r(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);